<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PhenoType Morphology Profile Generator</title>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #ccc;
            padding: 20px;
        }

        #log {
            white-space: pre-wrap;
            margin-top: 20px;
        }

        .success {
            color: #4f4;
        }

        .error {
            color: #f44;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #4f4;
            width: 0%;
            transition: width 0.1s;
        }
    </style>
</head>

<body>
    <h1>Morphology Profile Generator</h1>
    <button id="startBtn">Start Generation</button>
    <button id="downloadBtn" disabled>Download JSON</button>
    <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="status">Ready</div>
    <div id="log"></div>

    <!-- Dependencies -->
    <script src="../app/morphology.js"></script>

    <script type="module">
        import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.18/vision_bundle.mjs";
        const { FaceLandmarker, FilesetResolver } = vision;

        let faceMesh;
        let profiles = {};
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        const progressFill = document.getElementById('progressFill');

        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            log(`[FATAL ERROR] ${msg}\n${url}:${line}:${col}\n${error?.stack || ''}`, 'error');
            return false;
        };

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type) div.className = type;
            logEl.prepend(div);
            console.log(msg);
        }

        async function init() {
            try {
                log('Loading MediaPipe Face Mesh fileset...');
                const filesetResolver = await FilesetResolver.forVisionTasks(
                    'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.18/wasm'
                );
                log('Creating FaceLandmarker...');
                faceMesh = await FaceLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: {
                        modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
                        delegate: 'GPU'
                    },
                    runningMode: 'IMAGE',
                    numFaces: 1
                });
                log('Model loaded successfully! Ready to start.', 'success');
                document.getElementById('startBtn').textContent = 'Start Generation (Ready)';
            } catch (err) {
                log(`Init failed: ${err.message}`, 'error');
                console.error(err);
            }
        }

        async function loadPhenotypeList() {
            const res = await fetch('../list.json');
            const data = await res.json();
            const names = [];
            data.forEach(group => {
                const sub = group[group.length - 1];
                sub.forEach(s => names.push(s[0]));
            });
            return names; // ["Nordid", "Alpinid", ...]
        }

        async function processImage(name, sex) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                // Try normal res first, fall back to basic if fails (though pattern is consistent in this app)
                const path = `../faces_lowres/${name.toLowerCase()}${sex}.jpg`;
                const basicPath = `../faces_lowres/basic/${name.toLowerCase()}${sex}.jpg`;

                img.onload = () => {
                    try {
                        const result = faceMesh.detect(img);
                        if (result.faceLandmarks && result.faceLandmarks.length > 0) {
                            const analysis = Morphology.analyze(result.faceLandmarks[0]);
                            resolve(analysis);
                        } else {
                            resolve(null);
                        }
                    } catch (e) {
                        console.error(e);
                        resolve(null);
                    }
                };

                img.onerror = () => {
                    // Try basic folder
                    img.src = basicPath;
                    img.onerror = () => resolve(null); // Give up
                };

                img.src = path;
            });
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                if (!faceMesh) {
                    log('Initializing model...');
                    await init();
                    if (!faceMesh) {
                        log('❌ Failed to initialize FaceMesh. Cannot proceed.', 'error');
                        return;
                    }
                }

                document.getElementById('startBtn').disabled = true;
                profiles = {};

                log('Loading phenotype list...');
                const names = await loadPhenotypeList();
                log(`Loaded list.json. Found ${names.length} phenotypes.`);

                const sexes = ['m', 'f'];
                const total = names.length * 2;
                let current = 0;

                log(`Processing ${total} images... (This may take a while)`);

                for (const name of names) {
                    for (const sex of sexes) {
                        const id = `${name}_${sex}`;
                        statusEl.textContent = `Processing ${id}...`;

                        // Small delay to allow UI to update
                        await new Promise(r => requestAnimationFrame(r));

                        const analysis = await processImage(name, sex);

                        if (analysis) {
                            profiles[id] = {
                                ...analysis.rawIndices,
                                faceShape: analysis.features.faceShape.value,
                                noseType: analysis.features.noseType.value,
                                eyeShape: analysis.features.eyeShape.value,
                                lipType: analysis.features.lipType.value,
                                jawType: analysis.features.jawType.value,
                                foreheadType: analysis.features.foreheadType.value,
                                cheekboneType: analysis.features.cheekboneType.value
                            };
                        } else {
                            log(`Skipped ${id} (No face detected or image missing)`, 'error');
                        }

                        current++;
                        progressFill.style.width = `${(current / total) * 100}%`;
                    }
                }

                statusEl.textContent = 'Done!';
                // Expose for automation
                window.generatedProfiles = profiles;
                window.generationDone = true;
                // Expose for automation
                window.generatedProfiles = profiles;
                window.generationDone = true;
                log(`✨ Generation complete! ${Object.keys(profiles).length} profiles generated.`, 'success');

                // Auto download
                const blob = new Blob([JSON.stringify(profiles, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const dlBtn = document.getElementById('downloadBtn');

                dlBtn.disabled = false;
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'morphology-profiles.json';
                    a.click();
                };

                log('⬇️ Downloading morphology-profiles.json...');
                dlBtn.click();

            } catch (err) {
                log(`❌ Error during generation: ${err.message}`, 'error');
                console.error(err);
                document.getElementById('startBtn').disabled = false;
            }
        });

        init();
    </script>
</body>

</html>